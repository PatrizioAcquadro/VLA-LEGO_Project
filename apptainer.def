# ============================================================================
# Apptainer Definition File for VLA-LEGO
#
# NOTE: This file is NOT used by CI/CD. Apptainer images are built from the
# Docker image digest for consistency. This file is provided for manual
# standalone builds on HPC systems without Docker access.
#
# IMPORTANT: This is a DEPS-ONLY build. The container does not include
# repository code. You must bind-mount your code at /workspace.
#
# Manual build (if needed):
#   apptainer build vla-lego.sif apptainer.def
#
# Recommended: Pull from GitHub Container Registry (built from Docker):
#   apptainer pull vla-lego.sif docker://ghcr.io/patrizioacquadro/vla-lego_project:latest
# ============================================================================

Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

%labels
    Author Patrizio Acquadro
    Email pacquadr@purdue.edu
    Version 0.2.0
    Description VLA-LEGO Model Training Environment

%post
    # Update and install system dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        curl \
        wget \
        ca-certificates \
        python3.10 \
        python3.10-dev \
        python3.10-venv \
        python3-pip \
        libgl1-mesa-glx \
        libgl1-mesa-dev \
        libosmesa6-dev \
        libglfw3 \
        libglfw3-dev \
        && rm -rf /var/lib/apt/lists/*

    # Set Python 3.10 as default
    update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1

    # Upgrade pip
    python -m pip install --upgrade pip setuptools wheel

    # Install PyTorch with CUDA support
    pip install --no-cache-dir \
        torch==2.2.0 \
        torchvision==0.17.0 \
        torchaudio==2.2.0 \
        --index-url https://download.pytorch.org/whl/cu121

    # Install dependencies
    pip install --no-cache-dir \
        numpy>=1.24.0 \
        hydra-core>=1.3.0 \
        omegaconf>=2.3.0 \
        wandb>=0.15.0 \
        tqdm>=4.65.0 \
        einops>=0.6.0 \
        safetensors>=0.3.0 \
        accelerate>=0.20.0 \
        deepspeed>=0.10.0 \
        pytest>=7.0.0 \
        "mujoco>=3.1.0,<4.0.0" \
        "imageio[ffmpeg]>=2.31.0"

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    pip cache purge

%environment
    export PYTHONUNBUFFERED=1
    export PYTHONDONTWRITEBYTECODE=1
    export CUDA_DEVICE_ORDER=PCI_BUS_ID
    export MUJOCO_GL=osmesa
    export LC_ALL=C

%runscript
    exec python "$@"

%test
    python -c "import torch; print(f'PyTorch {torch.__version__}')"
    python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
    python -c "import mujoco; print(f'MuJoCo {mujoco.__version__}')"

%help
    VLA-LEGO Training Container (Deps-Only)

    This container includes ONLY dependencies (CUDA, Python, PyTorch, etc.).
    You MUST bind-mount your code at /workspace.

    Usage on Gilbreth:
        # Using the wrapper script (recommended)
        ./scripts/apptainer-run.sh python -m train.trainer cluster=gilbreth

        # Manual execution with bind-mount
        apptainer exec --nv -B $(pwd):/workspace vla-lego.sif \
            /usr/local/bin/entrypoint.sh python -m train.trainer cluster=gilbreth

        # Interactive shell
        apptainer shell --nv -B $(pwd):/workspace vla-lego.sif

    Reproducibility:
        Each run prints git commit, Python version, and GPU info.
        Save this output for experiment tracking.

    The --nv flag enables NVIDIA GPU support.
